<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞—â–∏—Ç–∞ –æ—Ç –ó–æ–º–±–∏—Ç–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(to bottom, #2c3e50, #34495e);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        #gameContainer {
            background: #ecf0f1;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        #topBar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            background: #34495e;
            padding: 15px;
            border-radius: 5px;
            color: white;
        }
        .stat {
            font-size: 20px;
            font-weight: bold;
        }
        .stat span {
            color: #f1c40f;
        }
        #waveCounter {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 40px;
            border-radius: 10px;
            border: 3px solid #f1c40f;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            z-index: 1000;
        }
        #waveCounter .waveText {
            font-size: 28px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            text-align: center;
        }
        #shopBar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #2c3e50;
            border-radius: 5px;
        }
        .shopItem {
            background: #34495e;
            border: 3px solid #555;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            color: white;
            min-width: 100px;
        }
        .shopItem:hover {
            transform: scale(1.05);
            border-color: #f1c40f;
        }
        .shopItem.selected {
            border-color: #2ecc71;
            background: #27ae60;
        }
        .shopItem.cantAfford {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .icon {
            font-size: 40px;
            margin-bottom: 5px;
        }
        .price {
            color: #f1c40f;
            font-weight: bold;
        }
        canvas {
            border: 4px solid #2c3e50;
            background: #95a5a6;
            display: block;
            border-radius: 5px;
        }
        #gameOver {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 40px;
            border-radius: 10px;
            display: none;
            text-align: center;
            color: white;
            z-index: 1000;
        }
        #gameOver h2 {
            color: #e74c3c;
            font-size: 48px;
            margin-bottom: 20px;
        }
        #gameOver p {
            font-size: 24px;
            margin-bottom: 20px;
        }
        button {
            font-size: 20px;
            padding: 15px 30px;
            cursor: pointer;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
        }
        button:hover {
            background: #2ecc71;
        }
        #upgradePanel {
            position: absolute;
            background: rgba(44, 62, 80, 0.95);
            border: 3px solid #f1c40f;
            border-radius: 10px;
            padding: 15px;
            display: none;
            z-index: 100;
            color: white;
            min-width: 200px;
        }
        #upgradePanel h3 {
            margin: 0 0 10px 0;
            color: #f1c40f;
            text-align: center;
        }
        .upgradeBtn {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #27ae60;
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }
        .upgradeBtn:hover {
            background: #2ecc71;
        }
        .upgradeBtn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .towerInfo {
            text-align: center;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .closeUpgrade {
            background: #e74c3c;
            padding: 5px;
            font-size: 14px;
        }
        .closeUpgrade:hover {
            background: #c0392b;
        }
        #pauseBtn {
            background: #f39c12;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: all 0.3s;
        }
        #pauseBtn:hover {
            background: #e67e22;
            transform: scale(1.05);
        }
        #pauseBtn.paused {
            background: #27ae60;
        }
        #pauseBtn.paused:hover {
            background: #2ecc71;
        }
        #startScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        #startButton {
            font-size: 48px;
            padding: 30px 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 5px solid #f1c40f;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(241, 196, 15, 0.5);
            cursor: pointer;
            transition: all 0.3s;
        }
        #startButton:hover {
            transform: scale(1.1);
            box-shadow: 0 0 50px rgba(241, 196, 15, 0.8);
        }
        #bossHealthDisplay {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px 40px;
            border-radius: 15px;
            border: 3px solid #e74c3c;
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.5);
            display: none;
            z-index: 1500;
            min-width: 400px;
        }
        #bossHealthDisplay .bossIcon {
            font-size: 50px;
            text-align: center;
            margin-bottom: 10px;
        }
        #bossHealthDisplay .bossName {
            color: #f1c40f;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }
        #bossHealthDisplay .bossHealthBar {
            background: #2c3e50;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        #bossHealthDisplay .bossHealthFill {
            background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
            height: 100%;
            transition: width 0.3s;
        }
        #bossHealthDisplay .bossHealthText {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>
    <div id="startScreen">
        <button id="startButton" onclick="startGame()">‚ñ∂Ô∏è –°–¢–ê–†–¢</button>
    </div>
    
    <div id="bossHealthDisplay">
        <div class="bossIcon" id="bossIcon"></div>
        <div class="bossName" id="bossName"></div>
        <div class="bossHealthBar">
            <div class="bossHealthFill" id="bossHealthFill"></div>
            <div class="bossHealthText" id="bossHealthText"></div>
        </div>
    </div>
    
    <div id="waveCounter">
        <div class="waveText">üåä –í–™–õ–ù–ê <span id="waveDisplay">1</span> / 10</div>
    </div>
    <div id="gameContainer">
        <div id="topBar">
            <div class="stat">üí∞ –ú–æ–Ω–µ—Ç–∏: <span id="money">5</span></div>
            <div class="stat">üèõÔ∏è –ñ–∏–≤–æ—Ç –Ω–∞ –≥—Ä–∞–¥–∞: <span id="cityHealth">400</span></div>
            <div class="stat">üíÄ –£–±–∏—Ç–∏: <span id="kills">0</span></div>
            <div class="stat">‚è±Ô∏è –í—Ä–µ–º–µ: <span id="timer">0:00</span></div>
            <button id="pauseBtn" onclick="togglePause()">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
        </div>
        
        <div id="shopBar">
            <div class="shopItem" data-type="knife" data-cost="1">
                <div class="icon">üî™</div>
                <div>–ù–æ–∂—á–µ</div>
                <div class="price">1 üí∞</div>
            </div>
            <div class="shopItem" data-type="pistol" data-cost="1">
                <div class="icon">üî´</div>
                <div>–ü–∏—Å—Ç–æ–ª–µ—Ç</div>
                <div class="price">1 üí∞</div>
            </div>
            <div class="shopItem" data-type="rifle" data-cost="3">
                <div class="icon">üéØ</div>
                <div>–ü—É—à–∫–∞</div>
                <div class="price">3 üí∞</div>
            </div>
            <div class="shopItem" data-type="tank" data-cost="10">
                <div class="icon">üöú</div>
                <div>–¢–∞–Ω–∫</div>
                <div class="price">10 üí∞</div>
            </div>
            <div class="shopItem" data-type="rpg" data-cost="7">
                <div class="icon">üöÄ</div>
                <div>RPG</div>
                <div class="price">7 üí∞</div>
            </div>
            <div class="shopItem" data-type="bunker" data-cost="15">
                <div class="icon">üè∞</div>
                <div>–ë—É–Ω–∫–µ—Ä</div>
                <div class="price">15 üí∞</div>
            </div>
            <div class="shopItem" data-type="minigun" data-cost="25">
                <div class="icon">‚ö°</div>
                <div>Minigun</div>
                <div class="price">25 üí∞</div>
            </div>
            <div class="shopItem" data-type="robot" data-cost="50">
                <div class="icon">ü§ñ</div>
                <div>–†–æ–±–æ—Ç</div>
                <div class="price">50 üí∞</div>
            </div>
            <div class="shopItem" id="bombBtn" data-type="bomb" data-cost="20" style="background: #c0392b;">
                <div class="icon">üí£</div>
                <div>–ë–æ–º–±–∞—Ä–¥–∏—Ä–∞–Ω–µ</div>
                <div class="price">20 üí∞</div>
            </div>
        </div>
        
        <canvas id="gameCanvas" width="900" height="500"></canvas>
    </div>

    <div id="gameOver">
        <h2>–ö–†–ê–ô –ù–ê –ò–ì–†–ê–¢–ê!</h2>
        <p>–ì—Ä–∞–¥—ä—Ç –µ —É–Ω–∏—â–æ–∂–µ–Ω!</p>
        <p>–£–±–∏—Ç–∏ –∑–æ–º–±–∏—Ç–∞: <span id="finalKills">0</span></p>
        <button onclick="restartGame()">–ò–≥—Ä–∞–π –æ—Ç–Ω–æ–≤–æ</button>
    </div>

    <div id="upgradePanel">
        <h3>‚¨ÜÔ∏è –™–ø–≥—Ä–µ–π–¥</h3>
        <div class="towerInfo">
            <div id="towerIcon" style="font-size: 40px;"></div>
            <div id="towerLevel"></div>
            <div id="towerDamage"></div>
        </div>
        <button class="upgradeBtn" id="upgradeBtn" onclick="upgradeTower()"></button>
        <button class="upgradeBtn closeUpgrade" onclick="closeUpgradePanel()">‚ùå –ó–∞—Ç–≤–æ—Ä–∏</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Game state
        let money = 5;
        let cityHealth = 400;
        let kills = 0;
        let gameRunning = false;
        let gameStarted = false;
        let gamePaused = false;
        let selectedTower = null;
        
        // Money generation
        let moneyTimer = 0;
        const moneyInterval = 120; // 120 frames = 2 seconds at 60fps
        
        // Grid system
        const gridSize = 50;
        const pathY = 250; // Middle of canvas
        const grid = [];
        
        // Initialize grid
        for (let x = 0; x < canvas.width; x += gridSize) {
            for (let y = 0; y < canvas.height; y += gridSize) {
                // Don't allow towers on the path
                if (y >= pathY - gridSize && y <= pathY + gridSize) {
                    grid.push({ x, y, occupied: false, isPath: true });
                } else {
                    grid.push({ x, y, occupied: false, isPath: false });
                }
            }
        }
        
        // Towers
        let towers = [];
        const towerTypes = {
            knife: { 
                cost: 1, 
                fireRate: 70, 
                baseDamage: 0.5, 
                range: 100, 
                icon: 'üî™', 
                color: '#95a5a6',
                upgradeCosts: [1, 2],
                bulletIcon: 'üî™'
            },
            pistol: { 
                cost: 1, 
                fireRate: 60, 
                baseDamage: 1, 
                range: 120, 
                icon: 'üî´', 
                color: '#3498db',
                upgradeCosts: [2, 3]
            },
            rifle: { 
                cost: 3, 
                fireRate: 30, 
                baseDamage: 2, 
                range: 150, 
                icon: 'üéØ', 
                color: '#e67e22',
                upgradeCosts: [6, 9]
            },
            tank: { 
                cost: 10, 
                fireRate: 15, 
                baseDamage: 3, 
                range: 180, 
                icon: 'üöú', 
                color: '#34495e',
                upgradeCosts: [20, 30]
            },
            rpg: {
                cost: 7,
                fireRate: 180,
                baseDamage: 30,
                range: 250,
                icon: 'üöÄ',
                color: '#e67e22',
                upgradeCosts: [14, 21],
                bulletIcon: 'üí•',
                isExplosive: true,
                explosionRadius: 60
            },
            bunker: { 
                cost: 15, 
                fireRate: 8, 
                baseDamage: 2.5, 
                range: 200, 
                icon: 'üè∞', 
                color: '#7f8c8d',
                upgradeCosts: [20, 30],
                bulletIcon: 'üî•'
            },
            minigun: {
                cost: 25,
                fireRate: 3,
                baseDamage: 0.8,
                range: 160,
                icon: '‚ö°',
                color: '#95a5a6',
                upgradeCosts: [50, 75],
                bulletIcon: '‚Ä¢'
            },
            robot: {
                cost: 50,
                fireRate: 30,
                baseDamage: 25,
                range: 220,
                icon: 'ü§ñ',
                color: '#3498db',
                upgradeCosts: [100, 150],
                bulletIcon: '‚ö°',
                isExplosive: true,
                explosionRadius: 50,
                dualMode: true
            }
        };
        
        // Currently selected tower for upgrade
        let selectedTowerForUpgrade = null;
        
        // Bomb effects
        let bombEffects = [];
        let explosionEffects = [];
        
        // Boss tracking
        let currentBoss = null;
        
        // Start game function
        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            gameRunning = true;
            gameStarted = true;
        }
        
        // Toggle pause
        function togglePause() {
            if (!gameRunning || !gameStarted) return;
            
            gamePaused = !gamePaused;
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (gamePaused) {
                pauseBtn.textContent = '‚ñ∂Ô∏è –ü—Ä–æ–¥—ä–ª–∂–∏';
                pauseBtn.classList.add('paused');
            } else {
                pauseBtn.textContent = '‚è∏Ô∏è –ü–∞—É–∑–∞';
                pauseBtn.classList.remove('paused');
            }
        }
        
        // Bombardment function
        function bombardPath() {
            // Deal 1000 damage to all zombies
            for (let i = zombies.length - 1; i >= 0; i--) {
                const zombie = zombies[i];
                zombie.health -= 1000;
                if (zombie.health <= 0) {
                    zombies.splice(i, 1);
                    kills++;
                    // Award money for kill
                    money += zombie.isBoss ? 10 : 1;
                }
            }
            
            // Create explosion effects along the path
            for (let i = 0; i < 10; i++) {
                bombEffects.push({
                    x: Math.random() * canvas.width,
                    y: pathY + (Math.random() - 0.5) * 100,
                    size: 30 + Math.random() * 40,
                    opacity: 1,
                    decay: 0.02 + Math.random() * 0.02
                });
            }
        }
        
        // Zombies
        let zombies = [];
        let zombieSpawnTimer = 0;
        let zombieSpawnRate = 120; // Spawn every 2 seconds
        let wave = 1;
        let bossSpawnCounter = 0;
        let bossSpawnInterval = 7;
        let gameTime = 0; // Game time in frames
        let finalBossSpawned = false;
        let megaBossSpawned = false;
        let ultraBossSpawned = false;
        
        // Bullets
        let bullets = [];
        
        // City position
        const city = { x: canvas.width - 100, y: pathY, width: 80, height: 80 };
        
        // Shop interaction
        document.querySelectorAll('.shopItem').forEach(item => {
            item.addEventListener('click', () => {
                const cost = parseInt(item.dataset.cost);
                const type = item.dataset.type;
                
                // Special handling for bomb
                if (type === 'bomb') {
                    if (money >= cost) {
                        money -= cost;
                        bombardPath();
                        updateUI();
                    }
                    return;
                }
                
                if (money >= cost) {
                    // Deselect others
                    document.querySelectorAll('.shopItem').forEach(i => i.classList.remove('selected'));
                    
                    if (selectedTower === type) {
                        selectedTower = null;
                    } else {
                        selectedTower = type;
                        item.classList.add('selected');
                    }
                }
            });
        });
        
        // Canvas click - place tower or select for upgrade
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Check if clicking on existing tower for upgrade
            if (!selectedTower && gameRunning) {
                let clickedTower = null;
                towers.forEach(tower => {
                    const dist = Math.hypot(x - tower.x, y - tower.y);
                    if (dist < 25) {
                        clickedTower = tower;
                    }
                });
                
                if (clickedTower) {
                    showUpgradePanel(clickedTower, e.clientX, e.clientY);
                    return;
                }
            }
            
            if (!selectedTower || !gameRunning) return;
            
            // Find grid cell
            const gridX = Math.floor(x / gridSize) * gridSize;
            const gridY = Math.floor(y / gridSize) * gridSize;
            
            const cell = grid.find(g => g.x === gridX && g.y === gridY);
            
            if (cell && !cell.occupied && !cell.isPath) {
                const towerType = towerTypes[selectedTower];
                
                if (money >= towerType.cost) {
                    money -= towerType.cost;
                    cell.occupied = true;
                    
                    towers.push({
                        x: gridX + gridSize / 2,
                        y: gridY + gridSize / 2,
                        type: selectedTower,
                        fireTimer: 0,
                        gridX: gridX,
                        gridY: gridY,
                        level: 1,
                        damage: towerType.baseDamage,
                        ...towerType
                    });
                    
                    updateUI();
                    
                    // Deselect
                    selectedTower = null;
                    document.querySelectorAll('.shopItem').forEach(i => i.classList.remove('selected'));
                }
            }
        });
        
        // Right click to remove tower
        canvas.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            if (!gameRunning) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Find tower at this position
            towers.forEach((tower, index) => {
                const dist = Math.hypot(x - tower.x, y - tower.y);
                if (dist < 25) {
                    // Remove tower
                    towers.splice(index, 1);
                    
                    // Free up the grid cell
                    const cell = grid.find(g => g.x === tower.gridX && g.y === tower.gridY);
                    if (cell) cell.occupied = false;
                }
            });
        });
        
        // Show upgrade panel
        function showUpgradePanel(tower, mouseX, mouseY) {
            selectedTowerForUpgrade = tower;
            const panel = document.getElementById('upgradePanel');
            
            // Position panel near mouse
            panel.style.left = mouseX + 'px';
            panel.style.top = mouseY + 'px';
            panel.style.display = 'block';
            
            // Update panel content
            document.getElementById('towerIcon').textContent = tower.icon;
            document.getElementById('towerLevel').textContent = 'üìä –ù–∏–≤–æ: ' + tower.level + '/3';
            document.getElementById('towerDamage').textContent = '‚öîÔ∏è Damage: ' + tower.damage;
            
            const upgradeBtn = document.getElementById('upgradeBtn');
            
            if (tower.level >= 3) {
                upgradeBtn.textContent = '‚úÖ –ú–∞–∫—Å –Ω–∏–≤–æ';
                upgradeBtn.disabled = true;
            } else {
                const upgradeCost = tower.upgradeCosts[tower.level - 1];
                upgradeBtn.textContent = '‚¨ÜÔ∏è –ù–∏–≤–æ ' + (tower.level + 1) + ' (' + upgradeCost + ' üí∞)';
                upgradeBtn.disabled = money < upgradeCost;
            }
        }
        
        // Close upgrade panel
        function closeUpgradePanel() {
            document.getElementById('upgradePanel').style.display = 'none';
            selectedTowerForUpgrade = null;
        }
        
        // Upgrade tower
        function upgradeTower() {
            if (!selectedTowerForUpgrade || selectedTowerForUpgrade.level >= 3) return;
            
            const upgradeCost = selectedTowerForUpgrade.upgradeCosts[selectedTowerForUpgrade.level - 1];
            
            if (money >= upgradeCost) {
                money -= upgradeCost;
                selectedTowerForUpgrade.level++;
                selectedTowerForUpgrade.damage = selectedTowerForUpgrade.baseDamage * selectedTowerForUpgrade.level;
                
                // –£–≤–µ–ª–∏—á–∞–≤–∞–Ω–µ –Ω–∞ –æ–±—Å–µ–≥–∞ —Å –≤—Å—è–∫–æ –Ω–∏–≤–æ (30 –ø–∏–∫—Å–µ–ª–∞ –Ω–∞ –Ω–∏–≤–æ)
                const baseRange = towerTypes[selectedTowerForUpgrade.type].range;
                selectedTowerForUpgrade.range = baseRange + ((selectedTowerForUpgrade.level - 1) * 30);
                
                updateUI();
                showUpgradePanel(selectedTowerForUpgrade, 
                    parseInt(document.getElementById('upgradePanel').style.left),
                    parseInt(document.getElementById('upgradePanel').style.top)
                );
            }
        }
        
        // Spawn zombie
        function spawnZombie() {
            bossSpawnCounter++;
            
            const isBoss = bossSpawnCounter >= bossSpawnInterval;
            if (isBoss) bossSpawnCounter = 0;
            
            let baseHealth, size, speed, bossType;
            
            if (wave === 1) {
                baseHealth = isBoss ? 50 : 8;
                size = isBoss ? 80 : 40;
                speed = isBoss ? 0.25 : 0.6;
                bossType = 'normal';
            } else if (wave === 2) {
                baseHealth = isBoss ? 100 : 12;
                size = isBoss ? 90 : 40;
                speed = isBoss ? 0.3 : 0.7;
                bossType = 'purple';
            } else if (wave === 3) {
                baseHealth = isBoss ? 150 : 15;
                size = isBoss ? 100 : 40;
                speed = isBoss ? 0.35 : 0.8;
                bossType = 'elite';
            } else if (wave === 4) {
                baseHealth = isBoss ? 200 : 20;
                size = isBoss ? 105 : 40;
                speed = isBoss ? 0.4 : 0.9;
                bossType = 'advanced';
            } else if (wave === 5) {
                baseHealth = isBoss ? 250 : 25;
                size = isBoss ? 110 : 40;
                speed = isBoss ? 0.45 : 1.0;
                bossType = 'supreme';
            } else if (wave === 6) {
                baseHealth = isBoss ? 350 : 30;
                size = isBoss ? 115 : 40;
                speed = isBoss ? 0.5 : 1.1;
                bossType = 'final';
            } else if (wave === 7) {
                baseHealth = isBoss ? 500 : 35;
                size = isBoss ? 125 : 40;
                speed = isBoss ? 0.55 : 1.2;
                bossType = 'ultra';
            } else if (wave === 8) {
                baseHealth = isBoss ? 700 : 40;
                size = isBoss ? 135 : 40;
                speed = isBoss ? 0.6 : 1.3;
                bossType = 'mega';
            } else if (wave === 9) {
                baseHealth = isBoss ? 1000 : 45;
                size = isBoss ? 145 : 40;
                speed = isBoss ? 0.65 : 1.4;
                bossType = 'titan';
            } else {
                baseHealth = isBoss ? 1500 : 50;
                size = isBoss ? 160 : 40;
                speed = isBoss ? 0.7 : 1.5;
                bossType = 'apocalypse';
            }
            
            zombies.push({
                x: 0,
                y: pathY,
                width: size,
                height: size,
                speed: speed,
                health: baseHealth,
                maxHealth: baseHealth,
                isBoss: isBoss,
                bossType: bossType
            });
        }
        
        // Wave boss spawn tracking
        let waveBossSpawned = [false, false, false, false, false, false, false, false, false, false];
        
        // Spawn wave boss
        function spawnWaveBoss(waveNum) {
            if (waveBossSpawned[waveNum - 1]) return;
            waveBossSpawned[waveNum - 1] = true;
            
            const bossConfigs = [
                { type: 'normal', health: 1000, size: 85, speed: 0.25, damage: 8, name: 'Normal Boss' },
                { type: 'purple', health: 2000, size: 95, speed: 0.28, damage: 10, name: 'Purple Boss' },
                { type: 'elite', health: 3000, size: 105, speed: 0.3, damage: 12, name: 'Elite Boss' },
                { type: 'advanced', health: 4000, size: 110, speed: 0.32, damage: 14, name: 'Advanced Boss' },
                { type: 'supreme', health: 5000, size: 115, speed: 0.34, damage: 16, name: 'Supreme Boss' },
                { type: 'final', health: 6000, size: 125, speed: 0.36, damage: 18, name: 'Final Boss' },
                { type: 'ultra', health: 7000, size: 135, speed: 0.38, damage: 20, name: 'Ultra Boss' },
                { type: 'mega', health: 8000, size: 150, speed: 0.4, damage: 22, name: 'Mega Boss' },
                { type: 'titan', health: 9000, size: 165, speed: 0.42, damage: 25, name: 'Titan Boss' },
                { type: 'apocalypse', health: 10000, size: 180, speed: 0.45, damage: 30, name: 'Apocalypse Boss' }
            ];
            
            const config = bossConfigs[waveNum - 1];
            
            const boss = {
                x: 0,
                y: pathY,
                width: config.size,
                height: config.size,
                speed: config.speed,
                health: config.health,
                maxHealth: config.health,
                isBoss: true,
                bossType: config.type,
                bossDamage: config.damage,
                bossName: config.name
            };
            
            zombies.push(boss);
            currentBoss = boss;
            showBossHealth(boss);
        }
        
        // Show boss health display
        function showBossHealth(boss) {
            const display = document.getElementById('bossHealthDisplay');
            const icon = document.getElementById('bossIcon');
            const name = document.getElementById('bossName');
            
            const iconMap = {
                'normal': 'üëë',
                'purple': 'üëë',
                'elite': 'üëë',
                'advanced': 'üëë',
                'supreme': 'üëë',
                'final': 'üíÄ',
                'ultra': 'üî•',
                'mega': 'üëπ',
                'titan': '‚ö°',
                'apocalypse': '‚ò†Ô∏è'
            };
            
            icon.textContent = iconMap[boss.bossType] || 'üëë';
            name.textContent = boss.bossName || 'Boss';
            display.style.display = 'block';
        }
        
        // Update boss health display
        function updateBossHealth() {
            if (!currentBoss || !zombies.includes(currentBoss)) {
                document.getElementById('bossHealthDisplay').style.display = 'none';
                currentBoss = null;
                return;
            }
            
            const healthPercent = (currentBoss.health / currentBoss.maxHealth) * 100;
            document.getElementById('bossHealthFill').style.width = healthPercent + '%';
            document.getElementById('bossHealthText').textContent = Math.ceil(currentBoss.health) + ' / ' + currentBoss.maxHealth;
        }
        
        // Update UI
        function updateUI() {
            document.getElementById('money').textContent = money;
            document.getElementById('cityHealth').textContent = cityHealth;
            document.getElementById('kills').textContent = kills;
            document.getElementById('waveDisplay').textContent = wave;
            
            const seconds = Math.floor(gameTime / 60);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            document.getElementById('timer').textContent = minutes + ':' + (remainingSeconds < 10 ? '0' : '') + remainingSeconds;
            
            // Update shop items affordability
            document.querySelectorAll('.shopItem').forEach(item => {
                const cost = parseInt(item.dataset.cost);
                if (money < cost) {
                    item.classList.add('cantAfford');
                } else {
                    item.classList.remove('cantAfford');
                }
            });
        }
        
        // Draw grid
        function drawGrid() {
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.lineWidth = 1;
            
            grid.forEach(cell => {
                if (!cell.isPath) {
                    ctx.strokeRect(cell.x, cell.y, gridSize, gridSize);
                    
                    // Highlight on hover with selected tower
                    if (selectedTower && !cell.occupied) {
                        ctx.fillStyle = 'rgba(46, 204, 113, 0.3)';
                        ctx.fillRect(cell.x, cell.y, gridSize, gridSize);
                    }
                }
            });
        }
        
        // Draw path
        function drawPath() {
            ctx.fillStyle = '#7f8c8d';
            ctx.fillRect(0, pathY - 40, canvas.width, 80);
            
            // Path lines
            ctx.strokeStyle = '#f1c40f';
            ctx.lineWidth = 3;
            ctx.setLineDash([20, 10]);
            ctx.beginPath();
            ctx.moveTo(0, pathY);
            ctx.lineTo(canvas.width, pathY);
            ctx.stroke();
            ctx.setLineDash([]);
        }
        
        // Draw city
        function drawCity() {
            const buildings = [
                { x: city.x, y: city.y - 50, w: 80, h: 90, color: '#8B4513' },
                { x: city.x + 20, y: city.y - 70, w: 50, h: 110, color: '#A0522D' },
                { x: city.x + 50, y: city.y - 45, w: 40, h: 85, color: '#CD853F' }
            ];
            
            buildings.forEach(building => {
                // Building body
                ctx.fillStyle = building.color;
                ctx.fillRect(building.x, building.y, building.w, building.h);
                
                // Building outline
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.strokeRect(building.x, building.y, building.w, building.h);
                
                // Windows
                ctx.fillStyle = '#FFD700';
                const windowRows = Math.floor(building.h / 20);
                const windowCols = Math.floor(building.w / 20);
                for (let row = 0; row < windowRows; row++) {
                    for (let col = 0; col < windowCols; col++) {
                        if (Math.random() > 0.3) {
                            ctx.fillRect(
                                building.x + 5 + col * 20,
                                building.y + 5 + row * 20,
                                10, 12
                            );
                        }
                    }
                }
            });
            
            // Flag on tallest building
            ctx.fillStyle = '#2ecc71';
            ctx.fillRect(city.x + 43, city.y - 90, 4, 20);
            ctx.beginPath();
            ctx.moveTo(city.x + 47, city.y - 90);
            ctx.lineTo(city.x + 67, city.y - 80);
            ctx.lineTo(city.x + 47, city.y - 70);
            ctx.fill();
            
            // City health bar above city
            const barWidth = 100;
            const barHeight = 15;
            const barX = city.x - 5;
            const barY = city.y - 110;
            
            // Bar background
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(barX, barY, barWidth, barHeight);
            
            // Health fill
            const healthPercent = cityHealth / 400;
            let healthColor = '#2ecc71';
            if (healthPercent < 0.3) healthColor = '#e74c3c';
            else if (healthPercent < 0.6) healthColor = '#f39c12';
            
            ctx.fillStyle = healthColor;
            ctx.fillRect(barX, barY, barWidth * healthPercent, barHeight);
            
            // Bar border
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.strokeRect(barX, barY, barWidth, barHeight);
            
            // Health text
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.strokeText(cityHealth + ' / 400', barX + barWidth / 2, barY + barHeight / 2 + 4);
            ctx.fillText(cityHealth + ' / 400', barX + barWidth / 2, barY + barHeight / 2 + 4);
        }
        
        // Draw zombie
        function drawZombie(zombie) {
            let bodyColor, headColor, eyeColor;
            
            if (zombie.isBoss) {
                if (zombie.bossType === 'mega') {
                    bodyColor = '#1a0033';
                    headColor = '#330066';
                    eyeColor = '#FF00FF';
                } else if (zombie.bossType === 'ultra') {
                    bodyColor = '#8B4513';
                    headColor = '#D2691E';
                    eyeColor = '#FFA500';
                } else if (zombie.bossType === 'final') {
                    bodyColor = '#000000';
                    headColor = '#8B0000';
                    eyeColor = '#FF0000';
                } else if (zombie.bossType === 'supreme') {
                    bodyColor = '#2F4F4F';
                    headColor = '#708090';
                    eyeColor = '#00FFFF';
                } else if (zombie.bossType === 'advanced') {
                    bodyColor = '#800020';
                    headColor = '#C41E3A';
                    eyeColor = '#FFD700';
                } else if (zombie.bossType === 'purple') {
                    bodyColor = '#8B008B';
                    headColor = '#9370DB';
                    eyeColor = '#FFD700';
                } else if (zombie.bossType === 'elite') {
                    bodyColor = '#4B0082';
                    headColor = '#6A0DAD';
                    eyeColor = '#FF4500';
                } else if (zombie.bossType === 'titan') {
                    bodyColor = '#1C1C1C';
                    headColor = '#4A4A4A';
                    eyeColor = '#00FF00';
                } else if (zombie.bossType === 'apocalypse') {
                    bodyColor = '#660000';
                    headColor = '#990000';
                    eyeColor = '#FFFF00';
                } else {
                    bodyColor = '#8B0000';
                    headColor = '#DC143C';
                    eyeColor = '#FFD700';
                }
            } else {
                bodyColor = '#27ae60';
                headColor = '#2ecc71';
                eyeColor = '#e74c3c';
            }
            
            const headRadius = zombie.isBoss ? (zombie.bossType === 'mega' ? 60 : zombie.bossType === 'ultra' ? 55 : zombie.bossType === 'final' ? 50 : zombie.width / 2.5) : 15;
            const eyeSize = zombie.isBoss ? (zombie.bossType === 'mega' ? 18 : zombie.bossType === 'ultra' ? 16 : zombie.bossType === 'final' ? 15 : 10) : 5;
            
            // Body
            ctx.fillStyle = bodyColor;
            ctx.fillRect(zombie.x, zombie.y - 20, zombie.width, zombie.height);
            
            // Body details for mega and final boss
            if (zombie.bossType === 'mega') {
                ctx.fillStyle = '#330066';
                ctx.fillRect(zombie.x + 10, zombie.y, zombie.width - 20, zombie.height - 20);
                // Extra armor
                ctx.fillStyle = '#660099';
                ctx.fillRect(zombie.x + 20, zombie.y + 10, zombie.width - 40, zombie.height - 30);
            } else if (zombie.bossType === 'ultra') {
                ctx.fillStyle = '#D2691E';
                ctx.fillRect(zombie.x + 10, zombie.y, zombie.width - 20, zombie.height - 20);
                ctx.fillStyle = '#CD853F';
                ctx.fillRect(zombie.x + 20, zombie.y + 10, zombie.width - 40, zombie.height - 30);
            } else if (zombie.bossType === 'final') {
                ctx.fillStyle = '#8B0000';
                ctx.fillRect(zombie.x + 10, zombie.y, zombie.width - 20, zombie.height - 20);
            }
            
            // Head
            ctx.fillStyle = headColor;
            ctx.beginPath();
            ctx.arc(zombie.x + zombie.width / 2, zombie.y - 25, headRadius, 0, Math.PI * 2);
            ctx.fill();
            
            // Eyes
            ctx.fillStyle = eyeColor;
            const eyeOffset = zombie.isBoss ? (zombie.bossType === 'final' ? 20 : 15) : 12;
            ctx.fillRect(zombie.x + eyeOffset, zombie.y - 30, eyeSize, eyeSize);
            ctx.fillRect(zombie.x + zombie.width - eyeOffset - eyeSize, zombie.y - 30, eyeSize, eyeSize);
            
            // Boss crown/skull/demon
            if (zombie.isBoss) {
                ctx.font = (zombie.bossType === 'apocalypse' ? '50' : zombie.bossType === 'titan' ? '45' : zombie.bossType === 'mega' ? '40' : zombie.bossType === 'ultra' ? '38' : zombie.bossType === 'final' ? '35' : '20') + 'px Arial';
                ctx.textAlign = 'center';
                if (zombie.bossType === 'apocalypse') {
                    ctx.fillText('‚ò†Ô∏è', zombie.x + zombie.width / 2, zombie.y - 120);
                } else if (zombie.bossType === 'titan') {
                    ctx.fillText('‚ö°', zombie.x + zombie.width / 2, zombie.y - 110);
                } else if (zombie.bossType === 'mega') {
                    ctx.fillText('üëπ', zombie.x + zombie.width / 2, zombie.y - 100);
                } else if (zombie.bossType === 'ultra') {
                    ctx.fillText('üî•', zombie.x + zombie.width / 2, zombie.y - 90);
                } else if (zombie.bossType === 'final') {
                    ctx.fillText('üíÄ', zombie.x + zombie.width / 2, zombie.y - 80);
                } else {
                    ctx.fillText('üëë', zombie.x + zombie.width / 2, zombie.y - 45);
                }
            }
            
            // Health bar
            const barY = zombie.isBoss ? (zombie.bossType === 'mega' ? zombie.y - 120 : zombie.bossType === 'ultra' ? zombie.y - 110 : zombie.bossType === 'final' ? zombie.y - 100 : zombie.y - 55) : zombie.y - 40;
            const barHeight = zombie.bossType === 'mega' ? 12 : zombie.bossType === 'ultra' ? 11 : zombie.bossType === 'final' ? 10 : 6;
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(zombie.x, barY, zombie.width, barHeight);
            
            let healthBarColor = '#2ecc71';
            if (zombie.bossType === 'purple') healthBarColor = '#9370DB';
            if (zombie.bossType === 'elite') healthBarColor = '#6A0DAD';
            if (zombie.bossType === 'final') healthBarColor = '#FF0000';
            if (zombie.bossType === 'mega') healthBarColor = '#FF00FF';
            if (zombie.bossType === 'ultra') healthBarColor = '#FFA500';
            if (zombie.bossType === 'advanced') healthBarColor = '#FFD700';
            if (zombie.bossType === 'supreme') healthBarColor = '#00FFFF';
            if (zombie.bossType === 'titan') healthBarColor = '#00FF00';
            if (zombie.bossType === 'apocalypse') healthBarColor = '#FFFF00';
            
            ctx.fillStyle = healthBarColor;
            ctx.fillRect(zombie.x, barY, (zombie.health / zombie.maxHealth) * zombie.width, barHeight);
            
            // Health text for bosses
            if (zombie.isBoss) {
                ctx.fillStyle = '#fff';
                ctx.font = 'bold ' + (zombie.bossType === 'mega' ? '18' : zombie.bossType === 'ultra' ? '17' : zombie.bossType === 'final' ? '16' : '12') + 'px Arial';
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 3;
                ctx.strokeText(Math.ceil(zombie.health), zombie.x + zombie.width / 2, barY + (barHeight / 2) + 4);
                ctx.fillText(Math.ceil(zombie.health), zombie.x + zombie.width / 2, barY + (barHeight / 2) + 4);
            }
        }
        
        // Draw tower
        function drawTower(tower) {
            // Range circle (semi-transparent)
            ctx.strokeStyle = 'rgba(52, 152, 219, 0.3)';
            ctx.fillStyle = 'rgba(52, 152, 219, 0.1)';
            ctx.beginPath();
            ctx.arc(tower.x, tower.y, tower.range, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            // Tower base - size based on level
            const baseSize = 35 + (tower.level * 5);
            ctx.fillStyle = tower.color;
            ctx.fillRect(tower.x - baseSize/2, tower.y - baseSize/2, baseSize, baseSize);
            
            // Level border
            if (tower.level === 2) {
                ctx.strokeStyle = '#3498db';
                ctx.lineWidth = 3;
                ctx.strokeRect(tower.x - baseSize/2, tower.y - baseSize/2, baseSize, baseSize);
            } else if (tower.level === 3) {
                ctx.strokeStyle = '#f1c40f';
                ctx.lineWidth = 4;
                ctx.strokeRect(tower.x - baseSize/2, tower.y - baseSize/2, baseSize, baseSize);
            }
            
            // Tower icon
            ctx.font = (25 + tower.level * 5) + 'px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(tower.icon, tower.x, tower.y);
            
            // Level indicator
            ctx.font = 'bold 12px Arial';
            ctx.fillStyle = '#f1c40f';
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            const levelText = 'Lv' + tower.level;
            ctx.strokeText(levelText, tower.x, tower.y - baseSize/2 - 8);
            ctx.fillText(levelText, tower.x, tower.y - baseSize/2 - 8);
        }
        
        // Draw bullet
        function drawBullet(bullet) {
            if (bullet.icon) {
                // Draw special icon (knife or fire)
                ctx.font = bullet.icon === 'üî•' ? '16px Arial' : '20px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(bullet.icon, bullet.x, bullet.y);
            } else {
                // Draw regular bullet
                ctx.fillStyle = '#f39c12';
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, 5, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        // Update game
        function update() {
            if (!gameRunning || gamePaused) return;
            
            // Update game time
            gameTime++;
            
            // Wave system: 10 waves x 2 minutes each = 20 minutes total
            const seconds = Math.floor(gameTime / 60);
            
            // Determine current wave (each wave is 120 seconds)
            if (seconds < 120) {
                wave = 1;
                zombieSpawnRate = 120;
                bossSpawnInterval = 8;
                if (seconds >= 110) spawnWaveBoss(1);
            } else if (seconds < 240) {
                wave = 2;
                zombieSpawnRate = 100;
                bossSpawnInterval = 7;
                if (seconds >= 230) spawnWaveBoss(2);
            } else if (seconds < 360) {
                wave = 3;
                zombieSpawnRate = 80;
                bossSpawnInterval = 6;
                if (seconds >= 350) spawnWaveBoss(3);
            } else if (seconds < 480) {
                wave = 4;
                zombieSpawnRate = 70;
                bossSpawnInterval = 5;
                if (seconds >= 470) spawnWaveBoss(4);
            } else if (seconds < 600) {
                wave = 5;
                zombieSpawnRate = 60;
                bossSpawnInterval = 5;
                if (seconds >= 590) spawnWaveBoss(5);
            } else if (seconds < 720) {
                wave = 6;
                zombieSpawnRate = 50;
                bossSpawnInterval = 4;
                if (seconds >= 710) spawnWaveBoss(6);
            } else if (seconds < 840) {
                wave = 7;
                zombieSpawnRate = 45;
                bossSpawnInterval = 4;
                if (seconds >= 830) spawnWaveBoss(7);
            } else if (seconds < 960) {
                wave = 8;
                zombieSpawnRate = 40;
                bossSpawnInterval = 3;
                if (seconds >= 950) spawnWaveBoss(8);
            } else if (seconds < 1080) {
                wave = 9;
                zombieSpawnRate = 35;
                bossSpawnInterval = 3;
                if (seconds >= 1070) spawnWaveBoss(9);
            } else {
                wave = 10;
                zombieSpawnRate = 30;
                bossSpawnInterval = 2;
                if (seconds >= 1190) spawnWaveBoss(10);
            }
            
            // Update UI every second
            if (gameTime % 60 === 0) {
                updateUI();
            }
            
            // Money generation
            moneyTimer++;
            if (moneyTimer >= moneyInterval) {
                money++;
                moneyTimer = 0;
                updateUI();
            }
            
            // Spawn zombies
            zombieSpawnTimer++;
            if (zombieSpawnTimer >= zombieSpawnRate) {
                spawnZombie();
                zombieSpawnTimer = 0;
            }
            
            // Update zombies
            zombies.forEach((zombie, zIndex) => {
                zombie.x += zombie.speed;
                
                // Check if reached city
                if (zombie.x + zombie.width >= city.x) {
                    let damage = 1;
                    if (zombie.isBoss) {
                        damage = zombie.bossDamage || 10;
                    }
                    cityHealth -= damage;
                    zombies.splice(zIndex, 1);
                    updateUI();
                    
                    if (cityHealth <= 0) {
                        gameOver();
                    }
                }
            });
            
            // Update towers
            towers.forEach(tower => {
                tower.fireTimer++;
                
                if (tower.fireTimer >= tower.fireRate) {
                    // Find closest zombie in range
                    let closestZombie = null;
                    let closestDist = Infinity;
                    
                    zombies.forEach(zombie => {
                        const dist = Math.hypot(
                            zombie.x + zombie.width / 2 - tower.x,
                            zombie.y - tower.y
                        );
                        
                        if (dist < tower.range && dist < closestDist) {
                            closestZombie = zombie;
                            closestDist = dist;
                        }
                    });
                    
                    // Shoot at closest zombie
                    if (closestZombie) {
                        const angle = Math.atan2(
                            closestZombie.y - tower.y,
                            closestZombie.x + closestZombie.width / 2 - tower.x
                        );
                        
                        bullets.push({
                            x: tower.x,
                            y: tower.y,
                            vx: Math.cos(angle) * 8,
                            vy: Math.sin(angle) * 8,
                            damage: tower.damage,
                            target: closestZombie,
                            icon: tower.bulletIcon || null,
                            isExplosive: tower.isExplosive || false,
                            explosionRadius: tower.explosionRadius || 0
                        });
                        
                        tower.fireTimer = 0;
                    }
                }
            });
            
            // Update bullets
            bullets.forEach((bullet, bIndex) => {
                bullet.x += bullet.vx;
                bullet.y += bullet.vy;
                
                // Check collision with zombies
                zombies.forEach((zombie, zIndex) => {
                    if (bullet.x > zombie.x && bullet.x < zombie.x + zombie.width &&
                        bullet.y > zombie.y - 20 && bullet.y < zombie.y + 20) {
                        
                        // Handle explosion
                        if (bullet.isExplosive) {
                            // Create explosion effect
                            explosionEffects.push({
                                x: bullet.x,
                                y: bullet.y,
                                radius: 0,
                                maxRadius: bullet.explosionRadius,
                                opacity: 1
                            });
                            
                            // Damage all zombies in radius
                            zombies.forEach((z, zi) => {
                                const dist = Math.hypot(z.x + z.width / 2 - bullet.x, z.y - bullet.y);
                                if (dist < bullet.explosionRadius) {
                                    z.health -= bullet.damage;
                                    if (z.health <= 0) {
                                        zombies.splice(zi, 1);
                                        kills++;
                                        money += z.isBoss ? 10 : 1;
                                    }
                                }
                            });
                        } else {
                            zombie.health -= bullet.damage;
                            if (zombie.health <= 0) {
                                zombies.splice(zIndex, 1);
                                kills++;
                                money += zombie.isBoss ? 10 : 1;
                            }
                        }
                        
                        bullets.splice(bIndex, 1);
                        updateUI();
                    }
                });
                
                // Remove off-screen bullets
                if (bullet.x < 0 || bullet.x > canvas.width ||
                    bullet.y < 0 || bullet.y > canvas.height) {
                    bullets.splice(bIndex, 1);
                }
            });
            
            // Update boss health display
            updateBossHealth();
        }
        
        // Draw game
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            drawPath();
            drawGrid();
            drawCity();
            
            // Draw bomb effects
            bombEffects.forEach((effect, index) => {
                ctx.fillStyle = `rgba(255, 100, 0, ${effect.opacity})`;
                ctx.beginPath();
                ctx.arc(effect.x, effect.y, effect.size, 0, Math.PI * 2);
                ctx.fill();
                
                // Inner glow
                ctx.fillStyle = `rgba(255, 200, 0, ${effect.opacity * 0.7})`;
                ctx.beginPath();
                ctx.arc(effect.x, effect.y, effect.size * 0.6, 0, Math.PI * 2);
                ctx.fill();
                
                // Update effect
                effect.opacity -= effect.decay;
                effect.size += 2;
                
                // Remove finished effects
                if (effect.opacity <= 0) {
                    bombEffects.splice(index, 1);
                }
            });
            
            // Draw explosion effects
            explosionEffects.forEach((effect, index) => {
                ctx.fillStyle = `rgba(255, 150, 0, ${effect.opacity})`;
                ctx.beginPath();
                ctx.arc(effect.x, effect.y, effect.radius, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = `rgba(255, 255, 0, ${effect.opacity * 0.6})`;
                ctx.beginPath();
                ctx.arc(effect.x, effect.y, effect.radius * 0.6, 0, Math.PI * 2);
                ctx.fill();
                
                effect.radius += 3;
                effect.opacity -= 0.05;
                
                if (effect.opacity <= 0 || effect.radius >= effect.maxRadius) {
                    explosionEffects.splice(index, 1);
                }
            });
            
            towers.forEach(tower => drawTower(tower));
            zombies.forEach(zombie => drawZombie(zombie));
            bullets.forEach(bullet => drawBullet(bullet));
        }
        
        // Game over
        function gameOver() {
            gameRunning = false;
            document.getElementById('finalKills').textContent = kills;
            document.getElementById('gameOver').style.display = 'block';
        }
        
        // Restart game
        function restartGame() {
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('bossHealthDisplay').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
            
            money = 5;
            cityHealth = 400;
            kills = 0;
            gameRunning = false;
            gameStarted = false;
            gamePaused = false;
            towers = [];
            zombies = [];
            bullets = [];
            bombEffects = [];
            explosionEffects = [];
            selectedTower = null;
            selectedTowerForUpgrade = null;
            zombieSpawnTimer = 0;
            gameTime = 0;
            wave = 1;
            bossSpawnCounter = 0;
            currentBoss = null;
            waveBossSpawned = [false, false, false, false, false, false, false, false, false, false];
            
            // Reset grid
            grid.forEach(cell => {
                if (!cell.isPath) {
                    cell.occupied = false;
                }
            });
            
            updateUI();
            document.querySelectorAll('.shopItem').forEach(i => i.classList.remove('selected'));
            document.getElementById('pauseBtn').textContent = '‚è∏Ô∏è –ü–∞—É–∑–∞';
            document.getElementById('pauseBtn').classList.remove('paused');
            closeUpgradePanel();
        }
        
        // Game loop
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
        
        // Start game
        updateUI();
        gameLoop();
    </script>
</body>
</html>
    </script>
</body>
</html>